<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>POST DEMO</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <div id="pageContainer">
        <h1>Import Recipe Data</h1>
        <hr>
        <br>
        <form>
            <div>
                <input id="input" class="inputfile" type="file" name="csvFile" accept=".csv"> 
            </div>
            <button type="submit" id="submit">
                Submit
            </button>
        </form>
        <br>
        <button id="closeButton">
            Close Connection
        </button>
        <div id="myModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>Importing data...</p>
                <div id="myProgress">
                    <div id="myBar"></div>
                </div>
                <div id="dataList">Imported: <br><br></div>
            </div>
        </div>
    </div>

	<script>
        document.querySelector('#closeButton').addEventListener('click', (e) => {
            fetch('/close');
            alert("Connection closed");
        });
		document.querySelector('#submit').addEventListener('click', (e) => {
            e.preventDefault();
            const input = document.querySelector('#input');
            if(!input.files[0])
                alert('No File Added');
            else if(input.files[0].type != 'text/csv')
                alert('Wrong File Type');
            else {
                modal.style.display = "block";
                document.querySelector('#dataList').innerHTML = "Imported: <br><br>";
                const reader = new FileReader();
                reader.onload = () => {
                    let text = reader.result;
                    csvJSON(text);
                };
                reader.readAsText(input.files[0]);
            }
		});
        window.csvJSON = (csv) => {
            let lines = csv.split("\n");
            let headers = lines[0].split(",");
            let i = 1;
            window.add(lines, headers, i);
        }
        window.add = (lines, headers, i) => {
            let obj = {};
            let elements = lines[i].split(",", 5);
            let lists = lines[i].split("[");
            elements.push(lists[1].split("]")[0]);
            elements.push(lists[2].split("]")[0]);
            elements.push(lists[3].split("]")[0]);
            elements.push(lists[4].split("]")[0]);
            for (let j = 0; j < elements.length; j++) {
                obj[headers[j]] = elements[j];
            }
            fetch('/addRecipe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(obj),
            }).then((res) => {
                return res.json();
            }).then((data) => {
                let width = Math.floor((i/(lines.length-2))*100);
                if(data.value == 0)
                    document.querySelector('#dataList').innerHTML += obj.name + "<br>";
                document.querySelector('#myBar').style.width = width + "%";
                if(i == lines.length-2){
                    alert("Imported " + i + " rows!");
                    return;
                }
                else
                    window.add(lines, headers, i+1);
            });
        }

        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        }
	</script>
</body>

</html>
